version: '3.8'


services:
  dispatcher:
    build:
      context: .
      target: runtime
    image: fabreguesm/dispatcher_omnicanalidad-dispatcher:1.0.0
    ports:
      - "${PORT:-8082}:${PORT:-8082}"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PORT:-8082}
      - HOST=${HOST:-0.0.0.0}
      - USE_REDIS=${USE_REDIS:-true}
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB:-0}
      - WHATSAPP_TOKEN=${WHATSAPP_TOKEN}
      - PHONE_NUMBER_ID=${PHONE_NUMBER_ID}
      - VERIFY_TOKEN=${VERIFY_TOKEN}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}
      - BOT_APP=${BOT_APP}
      - ASESOR_APP=${ASESOR_APP}
      - ASESOR_CHANNEL_ID=${ASESOR_CHANNEL_ID:-1}
      - ASESOR_API_KEY=${ASESOR_API_KEY}
      - API_KEY=${API_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FILE=${LOG_FILE:-logs/dispatcher.log}
      - APP_TIMEOUT_MS=${APP_TIMEOUT_MS:-10000}
      - WHATSAPP_TIMEOUT_MS=${WHATSAPP_TIMEOUT_MS:-5000}
      - REDIS_TIMEOUT_MS=${REDIS_TIMEOUT_MS:-2000}
      - CIRCUIT_BREAKER_TIMEOUT_MS=${CIRCUIT_BREAKER_TIMEOUT_MS:-10000}
      - CIRCUIT_BREAKER_ERROR_THRESHOLD=${CIRCUIT_BREAKER_ERROR_THRESHOLD:-50}
      - CIRCUIT_BREAKER_RESET_TIMEOUT_MS=${CIRCUIT_BREAKER_RESET_TIMEOUT_MS:-30000}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dispatcher.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.dispatcher.entrypoints=websecure"
      - "traefik.http.routers.dispatcher.tls.certresolver=lets-encrypt"
      - "traefik.http.services.dispatcher.loadbalancer.server.port=${PORT:-8082}"
    networks:
      - traefik
    deploy:
      placement:
        constraints: ["${NODE}"]
      restart_policy:
        condition: on-failure
        max_attempts: 3
    logging:
      driver: loki
      options:
        loki-url: ${LOKI_URL}

networks:
  traefik:
    name: traefik
