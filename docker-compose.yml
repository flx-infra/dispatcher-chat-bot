version: '3.8'

services:
  # Dispatcher - Aplicación principal (sin Redis, usa almacenamiento en memoria)
  dispatcher:
    image: fabreguesm/dispatcher_omnicanalidad-dispatcher:1.0.2
    build:
      context: .
      target: runtime
    container_name: dispatcher-app
    ports:
      - "8082:8082"
    environment:
      # Servidor
      - NODE_ENV=production
      - PORT=8082
      - HOST=0.0.0.0
      - DOMAIN=${DOMAIN:-https://microserviciometa.flexxus.com.ar}

      # WhatsApp
      - WHATSAPP_TOKEN=${WHATSAPP_TOKEN}
      - PHONE_NUMBER_ID=${PHONE_NUMBER_ID}
      - VERIFY_TOKEN=${VERIFY_TOKEN:-LO_QUE_QUIERAS}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}

      # Aplicaciones (IMPORTANTE: Estas deben estar configuradas)
      - BOT_APP=${BOT_APP:-BOT|http://10.250.0.68:4800/webhook|1}
      - ASESOR_APP=${ASESOR_APP:-ASESOR|http://10.250.0.68:6001/api/external/conversations/create|2}

      # Configuración ASESOR
      - ASESOR_CHANNEL_ID=${ASESOR_CHANNEL_ID:-1}
      - ASESOR_API_KEY=${ASESOR_API_KEY:-LO_QUE_QUIERAS}

      # Redis (opcional)
      - USE_REDIS=${USE_REDIS:-false}
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB:-0}

      # Seguridad
      - API_KEY=${API_KEY:-LO_QUE_QUIERAS}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}

      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}

      # Logs
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FILE=${LOG_FILE:-logs/dispatcher.log}

      # Timeouts
      - APP_TIMEOUT_MS=${APP_TIMEOUT_MS:-10000}
      - WHATSAPP_TIMEOUT_MS=${WHATSAPP_TIMEOUT_MS:-5000}
      - REDIS_TIMEOUT_MS=${REDIS_TIMEOUT_MS:-2000}

      # Circuit Breaker
      - CIRCUIT_BREAKER_TIMEOUT_MS=${CIRCUIT_BREAKER_TIMEOUT_MS:-10000}
      - CIRCUIT_BREAKER_ERROR_THRESHOLD=${CIRCUIT_BREAKER_ERROR_THRESHOLD:-50}
      - CIRCUIT_BREAKER_RESET_TIMEOUT_MS=${CIRCUIT_BREAKER_RESET_TIMEOUT_MS:-30000}
    env_file:
      - .env
    volumes:
      # Hot reload en desarrollo - montar código fuente
      - ./src:/app/src
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8082/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
